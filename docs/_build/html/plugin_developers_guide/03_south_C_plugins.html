

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>South Plugins in C &mdash; FogLAMP  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="FogLAMP  documentation" href="../index.html"/>
        <link rel="up" title="Plugin Developer Guide" href="index.html"/>
        <link rel="next" title="C++ Support Classes" href="035_CPP.html"/>
        <link rel="prev" title="South Plugins" href="03_south_plugins.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> FogLAMP
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../processing_data.html">Processing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../foglamp_architecture.html">FogLAMP Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../foglamp_plugins.html">FogLAMP Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../securing_foglamp.html">Securing FogLAMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notifications.html">Notifications Service</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Plugin Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_FogLAMP_plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_writing_plugins.html">Writing and Using Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_south_plugins.html">South Plugins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">South Plugins in C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#polled-mode">Polled Mode</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#plugin-poll">Plugin Poll</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-poll-returning-multiple-values">Plugin Poll Returning Multiple Values</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#async-io-mode">Async IO Mode</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#plugin-register-ingest">Plugin Register Ingest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-start">Plugin Start</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-south-plugin-example-in-c-c-the-dht11-sensor">A South Plugin Example In C/C++: the DHT11 Sensor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-software">The Software</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-plugin">The Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-foglamp-and-adding-the-plugin">Building FogLAMP and Adding the Plugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="035_CPP.html">C++ Support Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="037_hybrid_plugins.html">Hybrid Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_north_plugins.html">North Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_storage_plugins.html">Storage Plugins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rest_api_guide/index.html">REST API Developers Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_index.html">Building FogLAMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../91_version_history.html">Version History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../92_downloads.html">Downloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../KERBEROS.html">Kerberos authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugin_index.html">Plugin Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">FogLAMP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Plugin Developer Guide</a> &raquo;</li>
        
      <li>South Plugins in C</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/plugin_developers_guide/03_south_C_plugins.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="south-plugins-in-c">
<h1>South Plugins in C<a class="headerlink" href="#south-plugins-in-c" title="Permalink to this headline">¶</a></h1>
<p>South plugins written in C/C++ are no different in use to those written in Python, it is merely a case that they are implemented in a different language. The same options of polled or asynchronous methods still exist and the enduser of FogLAMP is not aware in which language the plugin has been written.</p>
<div class="section" id="polled-mode">
<h2>Polled Mode<a class="headerlink" href="#polled-mode" title="Permalink to this headline">¶</a></h2>
<p>Polled mode is the simplest form of South plugin that can be written, a poll routine is called at an interval defined in the plugin advanced configuration. The South service determines the type of the plugin by examining the mode property in the information the plugin returns from the <em>plugin_info</em> call.</p>
<div class="section" id="plugin-poll">
<h3>Plugin Poll<a class="headerlink" href="#plugin-poll" title="Permalink to this headline">¶</a></h3>
<p>The plugin <em>poll</em> method is called periodically to collect the readings from a poll mode sensor. As with all other calls the argument passed to the method is the handle returned by the <em>plugin_init</em> call, the return of the method should be a <em>Reading</em> instance that contains the data read.</p>
<p>The <em>Reading</em> class consists of</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>assetName</td>
<td>The asset key of the sensor device that is being read</td>
</tr>
<tr class="row-odd"><td>userTimestamp</td>
<td>A timestamp for the reading data</td>
</tr>
<tr class="row-even"><td>datapoints</td>
<td>The reading data itself as a set if datapoint instances</td>
</tr>
</tbody>
</table>
<p>More detail regarding the <em>Reading</em> class can be found in the section <a href="035_CPP.html">C++ Support Classes</a>.</p>
<p>It is important that the <em>poll</em> method does not block as this will prevent the proper operation of the South microservice.  Using the example of our simple DHT11 device attached to a GPIO pin, the <em>poll</em> routine could be:</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Poll for a plugin reading</span>
<span class="cm"> */</span>
<span class="n">Reading</span> <span class="nf">plugin_poll</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">DHT11</span> <span class="o">*</span><span class="n">dht11</span> <span class="o">=</span> <span class="p">(</span><span class="n">DHT11</span><span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">takeReading</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where our <em>DHT11</em> class has a method <em>takeReading</em> as follows</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Take reading from sensor</span>
<span class="cm"> *</span>
<span class="cm"> * @param firstReading   This flag indicates whether this is the first reading to be taken from sensor,</span>
<span class="cm"> *                       if so get it reliably even if takes multiple retries. Subsequently (firstReading=false),</span>
<span class="cm"> *                       if reading from sensor fails, last good reading is returned.</span>
<span class="cm"> */</span>
<span class="n">Reading</span> <span class="n">DHT11</span><span class="o">::</span><span class="n">takeReading</span><span class="p">(</span><span class="kt">bool</span> <span class="n">firstReading</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">sensorData</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

        <span class="kt">bool</span> <span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">readSensorData</span><span class="p">(</span><span class="n">sensorData</span><span class="p">);</span>
                <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">firstReading</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_SENSOR_READ_RETRIES</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">firstReading</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_SENSOR_READ_RETRIES</span><span class="p">)</span>
                <span class="n">Logger</span><span class="o">::</span><span class="n">getLogger</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to get initial valid reading from DHT11 sensor connected to pin %d even after %d tries&quot;</span><span class="p">,</span> <span class="n">m_pin</span><span class="p">,</span> <span class="n">MAX_SENSOR_READ_RETRIES</span><span class="p">);</span>

        <span class="n">vector</span><span class="o">&lt;</span><span class="n">Datapoint</span> <span class="o">*&gt;</span> <span class="n">vec</span><span class="p">;</span>

        <span class="n">ostringstream</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sensorData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sensorData</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">DatapointValue</span> <span class="nf">dpv1</span><span class="p">(</span><span class="n">stod</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">str</span><span class="p">()));</span>
        <span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">new</span> <span class="n">Datapoint</span><span class="p">(</span><span class="s">&quot;Humidity&quot;</span><span class="p">,</span> <span class="n">dpv1</span><span class="p">));</span>

        <span class="n">ostringstream</span> <span class="n">tmp2</span><span class="p">;</span>
        <span class="n">tmp2</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sensorData</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span>  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sensorData</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="n">DatapointValue</span> <span class="nf">dpv2</span><span class="p">(</span><span class="n">stod</span><span class="p">(</span><span class="n">tmp2</span><span class="p">.</span><span class="n">str</span><span class="p">()));</span>
        <span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">new</span> <span class="n">Datapoint</span> <span class="p">(</span><span class="s">&quot;Temperature&quot;</span><span class="p">,</span> <span class="n">dpv2</span><span class="p">));</span>

        <span class="k">return</span> <span class="nf">Reading</span><span class="p">(</span><span class="n">m_assetName</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We are creating two <em>DatapointValues</em> for the Humidity and Temperature values returned by reading the DHT11 sensor.</p>
</div>
<div class="section" id="plugin-poll-returning-multiple-values">
<h3>Plugin Poll Returning Multiple Values<a class="headerlink" href="#plugin-poll-returning-multiple-values" title="Permalink to this headline">¶</a></h3>
<p>It is possible in a C/C++ plugin to have a plugin that returns multiple readings in a single call to a poll routine. This is done by setting the interface version of 2.0.0 rather than 1.0.0. In this interface version the <em>plugin_poll</em> call returns a vector of <em>Reading</em> rather than a single <em>Reading</em>.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Poll for a plugin reading</span>
<span class="cm"> */</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Reading</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">plugin_poll</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">Modbus</span> <span class="o">*</span><span class="n">modbus</span> <span class="o">=</span> <span class="p">(</span><span class="n">Modbus</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
                <span class="n">throw</span> <span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Bad plugin handle&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">modbus</span><span class="o">-&gt;</span><span class="n">takeReading</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="async-io-mode">
<h2>Async IO Mode<a class="headerlink" href="#async-io-mode" title="Permalink to this headline">¶</a></h2>
<p>In asyncio mode the plugin runs either a separate thread or uses some incoming event from a device or callback mechanism to trigger sending data to FogLAMP. The asynchronous mode uses two additional entry points to the plugin, one to register a callback on which the plugin sends data, <em>plugin_register_ingest</em>  and another to start the asynchronous behavior <em>plugin_start</em>.</p>
<div class="section" id="plugin-register-ingest">
<h3>Plugin Register Ingest<a class="headerlink" href="#plugin-register-ingest" title="Permalink to this headline">¶</a></h3>
<p>The <em>plugin_register_ingest</em> call is used to allow the south service to pass a callback function to the plugin that the plugin uses to send data to the service every time the plugin has some new data.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Register ingest callback</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plugin_register_ingest</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">INGEST_CB</span> <span class="n">cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">MyPluginClass</span> <span class="o">*</span><span class="n">plugin</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyPluginClass</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">exception</span><span class="p">();</span>
        <span class="n">plugin</span><span class="o">-&gt;</span><span class="n">registerIngest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The plugin should store the callback function pointer and the data associated with the callback such that it can use that information to pass a reading to the south service. The following code snippets show how a plugin class might store the callback and data and then use it to send readings into FogLAMP at a later stage.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Record the ingest callback function and data in member variables</span>
<span class="cm"> *</span>
<span class="cm"> * @param data  The Ingest function data</span>
<span class="cm"> * @param cb    The callback function to call</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">MyPluginClass</span><span class="o">::</span><span class="n">registerIngest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">INGEST_CB</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">m_ingest</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
        <span class="n">m_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when a data is available to send to the south service</span>
<span class="cm"> *</span>
<span class="cm"> * @param points        The points in the reading we must create</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">MyPluginClass</span><span class="o">::</span><span class="n">ingest</span><span class="p">(</span><span class="n">Reading</span><span class="o">&amp;</span> <span class="n">reading</span><span class="p">)</span>
<span class="p">{</span>

        <span class="p">(</span><span class="o">*</span><span class="n">m_ingest</span><span class="p">)(</span><span class="n">m_data</span><span class="p">,</span> <span class="n">reading</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="plugin-start">
<h3>Plugin Start<a class="headerlink" href="#plugin-start" title="Permalink to this headline">¶</a></h3>
<p>The <em>plugin_start</em> method, as with other plugin calls, is called with the plugin handle data that was returned from the <em>plugin_init</em> call. The <em>plugin_start</em> call will only be called once for a plugin, it is the responsibility of <em>plugin_start</em> to take whatever action is required in the plugin in order to start the asynchronous actions of the plugin. This might be to start a thread, register an endpoint for a remote connection or call an entry point in a third party library to start asynchronous processing.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Start the Async handling for the plugin</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plugin_start</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">MyPluginClass</span> <span class="o">*</span><span class="n">plugin</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyPluginClass</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>


        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">plugin</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Start the asynchronous processing thread</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">MyPluginClass</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
        <span class="n">m_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">m_thread</span> <span class="o">=</span> <span class="n">new</span> <span class="kr">thread</span><span class="p">(</span><span class="n">threadWrapper</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="a-south-plugin-example-in-c-c-the-dht11-sensor">
<h2>A South Plugin Example In C/C++: the DHT11 Sensor<a class="headerlink" href="#a-south-plugin-example-in-c-c-the-dht11-sensor" title="Permalink to this headline">¶</a></h2>
<p>Using the same example as before, the DHT11 temperature and humidity sensor, let’s look at how to create the plugin in C/C++.</p>
<div class="section" id="the-software">
<h3>The Software<a class="headerlink" href="#the-software" title="Permalink to this headline">¶</a></h3>
<p>For this plugin we use the wiringpi C library to connect to the hardware of the Raspberry Pi</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo apt-get install wiringpi
<span class="go">Reading package lists... Done</span>
<span class="go">Building dependency tree</span>
<span class="go">Reading state information... Done</span>
<span class="go">The following NEW packages will be installed:</span>
<span class="go">wiringpi</span>
<span class="go">...</span>
<span class="gp">$</span>
</pre></div>
</div>
</div>
<div class="section" id="the-plugin">
<h3>The Plugin<a class="headerlink" href="#the-plugin" title="Permalink to this headline">¶</a></h3>
<p>This is the code for the plugin.cpp file that provides the plugin API:</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * FogLAMP south plugin.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2018 OSisoft, LLC</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the Apache 2.0 Licence</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Amandeep Singh Arora</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;dht11.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;plugin_api.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;strings.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;logger.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;plugin_exception.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;config_category.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;rapidjson/document.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;version.h&gt;</span><span class="cp"></span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="cp">#define PLUGIN_NAME &quot;dht11_V2&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * Default configuration</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">QUOTE</span><span class="p">({</span>
                <span class="s">&quot;plugin&quot;</span> <span class="o">:</span> <span class="p">{</span>
                        <span class="s">&quot;description&quot;</span> <span class="o">:</span> <span class="s">&quot;DHT11 C south plugin&quot;</span><span class="p">,</span>
                        <span class="s">&quot;type&quot;</span> <span class="o">:</span> <span class="s">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s">&quot;default&quot;</span> <span class="o">:</span> <span class="n">PLUGIN_NAME</span><span class="p">,</span>
                        <span class="s">&quot;readonly&quot;</span><span class="o">:</span> <span class="s">&quot;true&quot;</span>
                        <span class="p">},</span>
                <span class="s">&quot;asset&quot;</span> <span class="o">:</span> <span class="p">{</span>
                        <span class="s">&quot;description&quot;</span> <span class="o">:</span> <span class="s">&quot;Asset name&quot;</span><span class="p">,</span>
                        <span class="s">&quot;type&quot;</span> <span class="o">:</span> <span class="s">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s">&quot;default&quot;</span> <span class="o">:</span> <span class="s">&quot;dht11&quot;</span><span class="p">,</span>
                        <span class="s">&quot;order&quot;</span><span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
                        <span class="s">&quot;displayName&quot;</span><span class="o">:</span> <span class="s">&quot;Asset Name&quot;</span><span class="p">,</span>
                        <span class="s">&quot;mandatory&quot;</span> <span class="o">:</span> <span class="s">&quot;true&quot;</span>
                        <span class="p">},</span>
                <span class="s">&quot;pin&quot;</span> <span class="o">:</span> <span class="p">{</span>
                        <span class="s">&quot;description&quot;</span> <span class="o">:</span> <span class="s">&quot;Rpi pin to which DHT11 is attached&quot;</span><span class="p">,</span>
                        <span class="s">&quot;type&quot;</span> <span class="o">:</span> <span class="s">&quot;integer&quot;</span><span class="p">,</span>
                        <span class="s">&quot;default&quot;</span> <span class="o">:</span> <span class="s">&quot;7&quot;</span><span class="p">,</span>
                        <span class="s">&quot;displayName&quot;</span><span class="o">:</span> <span class="s">&quot;Rpi Pin&quot;</span>
                        <span class="p">}</span>
                <span class="p">});</span>


<span class="cm">/**</span>
<span class="cm"> * The DHT11 plugin interface</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>

<span class="cm">/**</span>
<span class="cm"> * The plugin information structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">PLUGIN_INFORMATION</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">PLUGIN_NAME</span><span class="p">,</span>              <span class="c1">// Name</span>
        <span class="n">VERSION</span><span class="p">,</span>                  <span class="c1">// Version</span>
        <span class="mi">0</span><span class="p">,</span>                        <span class="c1">// Flags</span>
        <span class="n">PLUGIN_TYPE_SOUTH</span><span class="p">,</span>        <span class="c1">// Type</span>
        <span class="s">&quot;1.0.0&quot;</span><span class="p">,</span>                  <span class="c1">// Interface version</span>
        <span class="n">default_config</span>            <span class="c1">// Default configuration</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Return the information about this plugin</span>
<span class="cm"> */</span>
<span class="n">PLUGIN_INFORMATION</span> <span class="o">*</span><span class="nf">plugin_info</span><span class="p">()</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialise the plugin, called to get the plugin handle</span>
<span class="cm"> */</span>
<span class="n">PLUGIN_HANDLE</span> <span class="nf">plugin_init</span><span class="p">(</span><span class="n">ConfigCategory</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">itemExists</span><span class="p">(</span><span class="s">&quot;pin&quot;</span><span class="p">))</span>
        <span class="p">{</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">stoul</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;pin&quot;</span><span class="p">),</span> <span class="n">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">DHT11</span> <span class="o">*</span><span class="n">dht11</span><span class="o">=</span> <span class="n">new</span> <span class="n">DHT11</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">itemExists</span><span class="p">(</span><span class="s">&quot;asset&quot;</span><span class="p">))</span>
                <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">setAssetName</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;asset&quot;</span><span class="p">));</span>
        <span class="k">else</span>
                <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">setAssetName</span><span class="p">(</span><span class="s">&quot;dht11&quot;</span><span class="p">);</span>

        <span class="n">Logger</span><span class="o">::</span><span class="n">getLogger</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;m_assetName set to %s&quot;</span><span class="p">,</span> <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">getAssetName</span><span class="p">());</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">PLUGIN_HANDLE</span><span class="p">)</span><span class="n">dht11</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Poll for a plugin reading</span>
<span class="cm"> */</span>
<span class="n">Reading</span> <span class="nf">plugin_poll</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">DHT11</span> <span class="o">*</span><span class="n">dht11</span> <span class="o">=</span> <span class="p">(</span><span class="n">DHT11</span><span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">takeReading</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Reconfigure the plugin</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plugin_reconfigure</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">newConfig</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">ConfigCategory</span>        <span class="n">conf</span><span class="p">(</span><span class="s">&quot;dht&quot;</span><span class="p">,</span> <span class="n">newConfig</span><span class="p">);</span>
<span class="n">DHT11</span> <span class="o">*</span><span class="n">dht11</span> <span class="o">=</span> <span class="p">(</span><span class="n">DHT11</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">handle</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">itemExists</span><span class="p">(</span><span class="s">&quot;asset&quot;</span><span class="p">))</span>
                <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">setAssetName</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;asset&quot;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">itemExists</span><span class="p">(</span><span class="s">&quot;pin&quot;</span><span class="p">))</span>
        <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">stoul</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;pin&quot;</span><span class="p">),</span> <span class="n">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">dht11</span><span class="o">-&gt;</span><span class="n">setPin</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Shutdown the plugin</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plugin_shutdown</span><span class="p">(</span><span class="n">PLUGIN_HANDLE</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">DHT11</span> <span class="o">*</span><span class="n">dht11</span> <span class="o">=</span> <span class="p">(</span><span class="n">DHT11</span><span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
        <span class="n">delete</span> <span class="n">dht11</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The full source code, including the <em>DHT11</em> class can be found in GitHub <a href="https://github.com/foglamp-iot/foglamp-south-dht" target="_blank">https://github.com/foglamp-iot/foglamp-south-dht</a>
<br /></p>
</div>
<div class="section" id="building-foglamp-and-adding-the-plugin">
<h3>Building FogLAMP and Adding the Plugin<a class="headerlink" href="#building-foglamp-and-adding-the-plugin" title="Permalink to this headline">¶</a></h3>
<p>If you have not built FogLAMP yet, follow the steps described <a href="../03_getting_started.html#building-foglamp">here</a>. After the build, you can optionally install FogLAMP following <a href="../04_installation.html">these</a> steps.</p>
<ul class="simple">
<li>Clone the <em>foglamp-south-dht</em> repository</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://github.com/foglamp-iot/foglamp-south-dht.git
<span class="go">...</span>
<span class="gp">$</span>
</pre></div>
</div>
<ul class="simple">
<li>Set the environment variable FOGLAMP_ROOT to the directory in which you built FogLAMP</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">FOGLAMP_ROOT</span><span class="o">=</span>~/foglamp
<span class="gp">$</span>
</pre></div>
</div>
<ul class="simple">
<li>Go to the location in which you cloned the foglamp-south-dht repository and create a build directory and run cmake in that directory</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ~/foglamp-south-dht
<span class="gp">$</span> mkdir build
<span class="gp">$</span> <span class="nb">cd</span> build
<span class="gp">$</span> cmake ..
<span class="go">...</span>
<span class="gp">$</span>
</pre></div>
</div>
<ul class="simple">
<li>Now make the plugin</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make
<span class="gp">$</span>
</pre></div>
</div>
<ul class="simple">
<li>If you have started FogLAMP from the build directory, copy the plugin into the destination directory</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir -p <span class="nv">$FOGLAMP_ROOT</span>/plugins/south/dht
<span class="gp">$</span> cp libdht.so <span class="nv">$FOGLAMP_ROOT</span>/plugins/south/dht
<span class="gp">$</span>
</pre></div>
</div>
<ul class="simple">
<li>If you have installed FogLAMP by executing <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">make</span> <span class="pre">install</span></code>, copy the plugin into the destination directory</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo mkdir -p /usr/local/foglamp/plugins/south/dht
<span class="gp">$</span> sudo cp libdht.so /usr/local/foglamp/plugins/south/dht
<span class="gp">$</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have installed FogLAMP using an alternative <em>DESTDIR</em>, remember to add the path to the destination directory to the <code class="docutils literal"><span class="pre">cp</span></code> command.</p>
</div>
<ul class="simple">
<li>Add service</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -sX POST http://localhost:8081/foglamp/service -d <span class="s1">&#39;{&quot;name&quot;: &quot;dht&quot;, &quot;type&quot;: &quot;south&quot;, &quot;plugin&quot;: &quot;dht&quot;, &quot;enabled&quot;: true}&#39;</span>
</pre></div>
</div>
<p>You may now use the C/C++ plugin in exactly the same way as you used a Python plugin earlier.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="035_CPP.html" class="btn btn-neutral float-right" title="C++ Support Classes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="03_south_plugins.html" class="btn btn-neutral" title="South Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Dianomic Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>